# FonixFlow Release Process

> **ðŸ“˜ For the complete automated release workflow (Build â†’ Sign â†’ Notarize â†’ DMG â†’ GCS), see [doc/RELEASE_WORKFLOW.md](./doc/RELEASE_WORKFLOW.md) or use `./scripts/full_release.sh 1.0.1`**

## Quick Start

**Option 1: Automated (Recommended)**
```bash
# Complete workflow: Build â†’ Sign â†’ Notarize â†’ DMG â†’ GCS
./scripts/full_release.sh 1.0.1
```

**Option 2: Manual Steps**
```bash
# 1. Update version
# Edit app/version.py and increment version

# 2. Build app
pyinstaller fonixflow_qt.spec

# 3. Release to GCS
./scripts/release_to_gcs.sh 1.0.1
```

## Detailed Steps

### 1. Prepare Release

Update version in `app/version.py`:

```python
__version__ = "1.0.1"  # Increment version
__build__ = "101"      # Increment build
```

### 2. Build Application

```bash
# Clean previous build
rm -rf dist build

# Build with PyInstaller
pyinstaller fonixflow_qt.spec

# Verify app works
open dist/FonixFlow.app
```

### 3. Release to Google Cloud Storage

The automated script handles everything:

```bash
./scripts/release_to_gcs.sh 1.0.1
```

**What the script does:**
1. âœ“ Creates ZIP package from .app bundle
2. âœ“ Generates SHA256 hash for verification
3. âœ“ Uploads ZIP to GCS bucket
4. âœ“ Creates manifest.json with version info
5. âœ“ Uploads manifest to GCS
6. âœ“ Sets public read permissions
7. âœ“ Verifies deployment

### 4. Test Update

1. Launch the app
2. Wait 3 seconds (automatic check)
3. Update dialog should appear
4. Click "Update" to test download/install

## Google Cloud Storage Structure

```
gs://fonixflow-files/
â”œâ”€â”€ releases/                         # First-time downloads (DMG files)
â”‚   â”œâ”€â”€ FonixFlow_1.0.0_macos-arm.dmg
â”‚   â”œâ”€â”€ FonixFlow_1.0.1_macos-arm.dmg
â”‚   â””â”€â”€ ...
â””â”€â”€ updates/                          # Auto-updates (ZIP files)
    â”œâ”€â”€ macos-arm/
    â”‚   â”œâ”€â”€ manifest.json
    â”‚   â”œâ”€â”€ FonixFlow_1.0.0_macos-arm.zip
    â”‚   â”œâ”€â”€ FonixFlow_1.0.1_macos-arm.zip
    â”‚   â””â”€â”€ FonixFlow_1.0.2_macos-arm.zip
    â””â”€â”€ macos-intel/
        â”œâ”€â”€ manifest.json
        â””â”€â”€ ...
```

**Distribution Strategy:**
- **DMG files** (`releases/`) â†’ For first-time downloaders from website
- **ZIP files** (`updates/`) â†’ For automatic updates within the app

**Public URLs:**
- **First-time downloads (DMG):** https://storage.googleapis.com/fonixflow-files/releases/FonixFlow_X.Y.Z_platform.dmg
- **Auto-updates (ZIP):** https://storage.googleapis.com/fonixflow-files/updates/platform/FonixFlow_X.Y.Z_platform.zip
- **Manifest:** https://storage.googleapis.com/fonixflow-files/updates/platform/manifest.json

## Manifest Format

The `manifest.json` is auto-generated by the release script:

```json
{
  "latest_version": "1.0.1",
  "download_url": "https://storage.googleapis.com/fonixflow-files/updates/FonixFlow_1.0.1.zip",
  "release_notes": "Release notes here",
  "force_update": false,
  "file_hash": "sha256_hash_here",
  "minimum_version": "1.0.0",
  "release_date": "2025-11-28",
  "file_size_mb": 450
}
```

## Manual GCS Commands

If you need to manage files manually:

```bash
# List files
gsutil ls gs://fonixflow-files/updates/

# Upload file
gsutil cp file.zip gs://fonixflow-files/updates/

# Make public
gsutil acl ch -u AllUsers:R gs://fonixflow-files/updates/file.zip

# Download manifest
gsutil cp gs://fonixflow-files/updates/manifest.json .

# Delete old version
gsutil rm gs://fonixflow-files/updates/FonixFlow_1.0.0.zip
```

## Prerequisites

### Google Cloud SDK

Install if not already available:

```bash
# macOS (Homebrew)
brew install google-cloud-sdk

# Or download from
# https://cloud.google.com/sdk/docs/install

# Authenticate
gcloud auth login
gcloud config set project YOUR_PROJECT_ID
```

### Verify Access

```bash
# Test GCS access
gsutil ls gs://fonixflow-files/

# Should list bucket contents
```

## Troubleshooting

**"gsutil: command not found"**
- Install Google Cloud SDK (see Prerequisites)

**"AccessDeniedException: 403"**
- Run `gcloud auth login`
- Verify you have write access to the bucket

**Update not showing in app**
- Check 24h throttle (delete `~/.fonixflow/update_config.json`)
- Verify manifest URL: https://storage.googleapis.com/fonixflow-files/updates/manifest.json
- Check app logs for update check errors

**Hash verification fails**
- Regenerate hash: `shasum -a 256 dist/FonixFlow_X.Y.Z.zip`
- Update manifest.json with new hash

## Versioning Strategy

### Semantic Versioning (MAJOR.MINOR.PATCH)

- **MAJOR** (1.x.x): Breaking changes, major new features
- **MINOR** (x.1.x): New features, backward compatible
- **PATCH** (x.x.1): Bug fixes, small improvements

**Examples:**
- `1.0.0` â†’ `1.0.1`: Bug fixes (Deep Scan fix, transcription improvements)
- `1.0.1` â†’ `1.1.0`: New feature (e.g., faster-whisper integration)
- `1.1.0` â†’ `2.0.0`: Major rewrite (e.g., new UI framework)

## Security

- All files are served over HTTPS
- SHA256 hash verification prevents tampering
- 24-hour update check throttle prevents abuse
- Code signing recommended for production (see BUILD_MACOS.md)
