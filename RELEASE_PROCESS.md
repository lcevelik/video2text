# FonixFlow Release Process

## Quick Start

```bash
# 1. Update version
# Edit app/version.py and increment version

# 2. Build app
pyinstaller fonixflow_qt.spec

# 3. Release to GCS
./scripts/release_to_gcs.sh 1.0.1
```

## Detailed Steps

### 1. Prepare Release

Update version in `app/version.py`:

```python
__version__ = "1.0.1"  # Increment version
__build__ = "101"      # Increment build
```

### 2. Build Application

```bash
# Clean previous build
rm -rf dist build

# Build with PyInstaller
pyinstaller fonixflow_qt.spec

# Verify app works
open dist/FonixFlow.app
```

### 3. Release to Google Cloud Storage

The automated script handles everything:

```bash
./scripts/release_to_gcs.sh 1.0.1
```

**What the script does:**
1. ✓ Creates ZIP package from .app bundle
2. ✓ Generates SHA256 hash for verification
3. ✓ Uploads ZIP to GCS bucket
4. ✓ Creates manifest.json with version info
5. ✓ Uploads manifest to GCS
6. ✓ Sets public read permissions
7. ✓ Verifies deployment

### 4. Test Update

1. Launch the app
2. Wait 3 seconds (automatic check)
3. Update dialog should appear
4. Click "Update" to test download/install

## Google Cloud Storage Structure

```
gs://fonixflow-files/
├── FonixFlow.dmg                    # Latest DMG (manual)
├── updates/
│   ├── manifest.json               # Version metadata
│   ├── FonixFlow_1.0.0.zip        # Version packages
│   ├── FonixFlow_1.0.1.zip
│   └── FonixFlow_1.0.2.zip
```

**Public URLs:**
- Manifest: https://storage.googleapis.com/fonixflow-files/updates/manifest.json
- Packages: https://storage.googleapis.com/fonixflow-files/updates/FonixFlow_X.Y.Z.zip

## Manifest Format

The `manifest.json` is auto-generated by the release script:

```json
{
  "latest_version": "1.0.1",
  "download_url": "https://storage.googleapis.com/fonixflow-files/updates/FonixFlow_1.0.1.zip",
  "release_notes": "Release notes here",
  "force_update": false,
  "file_hash": "sha256_hash_here",
  "minimum_version": "1.0.0",
  "release_date": "2025-11-28",
  "file_size_mb": 450
}
```

## Manual GCS Commands

If you need to manage files manually:

```bash
# List files
gsutil ls gs://fonixflow-files/updates/

# Upload file
gsutil cp file.zip gs://fonixflow-files/updates/

# Make public
gsutil acl ch -u AllUsers:R gs://fonixflow-files/updates/file.zip

# Download manifest
gsutil cp gs://fonixflow-files/updates/manifest.json .

# Delete old version
gsutil rm gs://fonixflow-files/updates/FonixFlow_1.0.0.zip
```

## Prerequisites

### Google Cloud SDK

Install if not already available:

```bash
# macOS (Homebrew)
brew install google-cloud-sdk

# Or download from
# https://cloud.google.com/sdk/docs/install

# Authenticate
gcloud auth login
gcloud config set project YOUR_PROJECT_ID
```

### Verify Access

```bash
# Test GCS access
gsutil ls gs://fonixflow-files/

# Should list bucket contents
```

## Troubleshooting

**"gsutil: command not found"**
- Install Google Cloud SDK (see Prerequisites)

**"AccessDeniedException: 403"**
- Run `gcloud auth login`
- Verify you have write access to the bucket

**Update not showing in app**
- Check 24h throttle (delete `~/.fonixflow/update_config.json`)
- Verify manifest URL: https://storage.googleapis.com/fonixflow-files/updates/manifest.json
- Check app logs for update check errors

**Hash verification fails**
- Regenerate hash: `shasum -a 256 dist/FonixFlow_X.Y.Z.zip`
- Update manifest.json with new hash

## Versioning Strategy

### Semantic Versioning (MAJOR.MINOR.PATCH)

- **MAJOR** (1.x.x): Breaking changes, major new features
- **MINOR** (x.1.x): New features, backward compatible
- **PATCH** (x.x.1): Bug fixes, small improvements

**Examples:**
- `1.0.0` → `1.0.1`: Bug fixes (Deep Scan fix, transcription improvements)
- `1.0.1` → `1.1.0`: New feature (e.g., faster-whisper integration)
- `1.1.0` → `2.0.0`: Major rewrite (e.g., new UI framework)

## Security

- All files are served over HTTPS
- SHA256 hash verification prevents tampering
- 24-hour update check throttle prevents abuse
- Code signing recommended for production (see BUILD_MACOS.md)
